<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head xmlns:th="http://www.thymeleaf.org">
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!--
    - primary meta tags
    -->
    <title>Learning Progress Tracker - Youdemi</title>
    <meta name="title" content="Youdemi"/>
    <meta name="description" content="Track your learning progress and skill development"/>

    <!--
    - favicon
    -->
    <link rel="shortcut icon" th:href="@{/favicon.svg}" type="image/svg+xml"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!--
    - custom css link
    -->
    <link rel="stylesheet" th:href="@{/assets/css/courselist.css}"/>
    <link rel="stylesheet" th:href="@{/assets/css/layout_courselist.css}"/>
    <link rel="stylesheet" th:href="@{/assets/css/learning-tracker.css}"/>
</head>

<body>
<!--
- #HEADER
-->
<th:block th:insert="~{fragments/header :: header}"></th:block>

<main>
    <section class="section has-bg-image" th:style="|background-image: url('@{/assets/images/course-bg.png}')|">
        <div class="dashboard-container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Learning Progress Tracker</h1>
                <p class="dashboard-subtitle">Track your skill development and learning milestones</p>
            </div>

            <!-- Progress Overview -->
            <div class="progress-overview">
                <!-- Overall Progress -->
                <div class="overview-card">
                    <div class="card-header">
                        <h3 class="card-title">Overall Progress</h3>
                    </div>
                    <div class="progress-circle overall"
                         th:style="'background: conic-gradient(#ff6b6b ' + ${progressTracker.skillProcess} + '%, #f3f3f3 ' + ${progressTracker.skillProcess} + '% 100%)'">
                        <div class="progress-inner" th:text="${progressTracker.skillProcess + '%'}">77%</div>
                    </div>
                    <div class="progress-label"
                         th:text="|Across ${progressTracker.totalTrackedSkills} tracked skills|">
                        Across 6 tracked skills
                    </div>

                </div>

                <!-- Goals -->
                <div class="overview-card">
                    <div class="card-header">
                        <h3 class="card-title">Goals</h3>
                    </div>
                    <div class="progress-circle goals"
                         th:style="'background: conic-gradient(#4caf50 ' + ${progressTracker.goalPercent} + '%, #f3f3f3 ' + ${progressTracker.goalPercent} + '% 100%)'">
                        <div class="progress-inner">
                            <span th:text="${progressTracker.goalCompleted}">1/3</span>
                        </div>
                    </div>

                    <div class="progress-label">Goals completed</div>
                </div>


                <!-- Sessions -->
                <div class="overview-card">
                    <div class="card-header">
                        <h3 class="card-title">Sessions</h3>
                    </div>
                    <div class="progress-circle sessions">
                        <div class="progress-inner" th:text="${progressTracker.getTotalSkillsCompleted()}"></div>
                    </div>
                    <div class="progress-label">Mentoring Skills Completed</div>
                </div>
            </div>

            <!-- Tab Container -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn"
                            th:classappend="${activeTab} == 'skills' ? ' active' : ''"
                            th:onclick="'location.href=\'' + @{/learning-tracker(activeTab='skills')} + '\''">
                        Skills
                    </button>

                    <button class="tab-btn"
                            th:classappend="${activeTab} == 'goals' ? ' active' : ''"
                            th:onclick="'location.href=\'' + @{/learning-tracker(activeTab='goals')} + '\''">
                        Goals
                    </button>

                    <button class="tab-btn"
                            th:classappend="${activeTab} == 'sessions' ? ' active' : ''"
                            th:onclick="'location.href=\'' + @{/learning-tracker(activeTab='sessions')} + '\''">
                        Attendance
                    </button>
                </div>

                <!-- Skills Tab -->
                <div id="skills" class="tab-content"
                     th:classappend="(${activeTab} == null or ${activeTab} == 'skills') ? ' active' : ''">
                <div class="skills-header">
                        <h2 class="skills-title">Your Skills</h2>
                        <button class="add-skill-btn">Add New Skill</button>
                    </div>

                    <div class="skills-grid">
                        <div class="skill-card" th:each="skill : ${skills}">
                            <div class="skill-header">
                                <div>
                                    <div class="skill-name" th:text="${skill.courseTitle}">React</div>
                                    <div class="skill-tags">
                                        <span th:each="tag : ${skill.tags}" class="tag-badge" th:text="${tag}">Frontend</span>
                                    </div>
                                </div>
                                <div class="progress-percentage" th:text="${skill.progressPercentage + '%'}">65%</div>
                            </div>
                            <div class="skill-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" th:style="'width:' + ${skill.progressPercentage} + '%'"></div>
                                </div>
                            </div>
                            <div class="skill-details">
                                <span th:text="'Sessions completed: ' + ${skill.sessionsCompleted}">10</span>
                                <span th:text="'Total Sessions: ' + ${skill.totalSessions}">30</span>
                            </div>
                            <div class="skill-meta">
                                <span th:text="'Latest Session: ' + ${#temporals.format(skill.lastSessionDate, 'M/d/yyyy')}">5/12/2025</span>
                                <a class="details-link">Details</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Goals Tab -->
                <div id="goals" class="tab-content"
                     th:classappend="${activeTab eq 'goals'} ? ' active' : ''">
                    <div class="skills-header">
                        <h2 class="skills-title">Your Learning Goals</h2>
                        <button class="add-skill-btn" onclick="toggleGoalForm()">Create Goal</button>
                    </div>

                    <!-- Goal Form -->
                    <div id="goalFormContainer"
                         th:classappend="${showGoalForm} ? 'show' : ''"
                         class="goal-form-container">
                        <form th:action="@{/goals/create}" method="post" th:object="${newGoal}">
                            <div class="overview-card">
                                <div class="form-group">
                                    <label class="form-label">Goal Title</label>
                                    <input type="text" th:field="*{title}"
                                           class="form-input"
                                           th:classappend="${#fields.hasErrors('title')} ? 'is-invalid' : ''"
                                           placeholder="e.g., Do AI Agent Project" required>
                                    <div class="error-text" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <input type="text" th:field="*{description}"
                                           class="form-input"
                                           th:classappend="${#fields.hasErrors('description')} ? 'is-invalid' : ''"
                                           placeholder="e.g., Learn LangChain, Rag, etc." required>
                                    <div class="error-text" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Target Date</label>
                                    <input type="date" th:field="*{targetDate}" class="form-input" required>
                                </div>
                                <div class="form-footer" style="display: flex; justify-content: space-between; align-items: center;">
                                    <button type="submit" class="create-goal-btn">Create Goal</button>
                                    <button type="button" class="close-btn" onclick="toggleGoalForm()">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Goal List -->
                    <div class="goals-list">
                        <div class="goal-item" th:each="goal : ${goals}" th:classappend="${goal.status.name().toLowerCase().replace('_', '-')}">
                            <div class="goal-header">
                                <div class="goal-title" th:text="${goal.title}">Build Portfolio Website</div>
                                <span th:text="'Due: ' + ${#temporals.format(goal.targetDate, 'M/d/yyyy')}">Due: 6/30/2025</span>
                            </div>
                            <div class="goal-description" th:text="${goal.description}">Description of the goal</div>
                            <form th:action="@{/goals/edit}" method="post" class="edit-goal-form" style="display: none;">
                                <input type="hidden" name="goalId" th:value="${goal.id}" />

                                <div class="form-group">
                                    <label>Title</label>
                                    <input type="text" name="title" th:value="${goal.title}" required />
                                </div>

                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" name="description" th:value="${goal.description}" required />
                                </div>

                                <div class="form-group">
                                    <label>Target Date</label>
                                    <input type="date" name="targetDate"
                                           th:value="${goal.targetDate != null} ? ${#temporals.format(goal.targetDate, 'yyyy-MM-dd')} : ''"
                                           required />
                                </div>

                                <div class="form-footer" style="margin-top: 10px; display: flex; gap: 10px;">
                                    <button type="submit" class="save-edit-btn">Save</button>
                                    <button type="button" class="cancel-edit-btn" onclick="toggleEditForm(this)">Cancel</button>
                                </div>
                            </form>
                            <!-- Status buttons -->
                            <div class="progress-buttons">
                                <form th:action="@{/goals/update-status}" method="post" class="status-form">
                                    <input type="hidden" name="goalId" th:value="${goal.id}" />
                                    <input type="hidden" name="status" class="status-input" th:value="${goal.status}" />

                                    <button type="button"
                                            class="progress-btn todo"
                                            th:classappend="${goal.status.name() == 'TODO'} ? 'active' : ''"
                                            onclick="setGoalStatus(this, 'TODO')">To-do</button>

                                    <button type="button"
                                            class="progress-btn in-progress"
                                            th:classappend="${goal.status.name() == 'IN_PROGRESS'} ? 'active' : ''"
                                            onclick="setGoalStatus(this, 'IN_PROGRESS')">In Progress</button>

                                    <button type="button"
                                            class="progress-btn done"
                                            th:classappend="${goal.status.name() == 'DONE'} ? 'active' : ''"
                                            onclick="setGoalStatus(this, 'DONE')">Done</button>
                                </form>
                            </div>
                            <div class="goal-actions">
                                <a href="javascript:void(0);" class="edit-btn" onclick="toggleEditForm(this)">Edit</a>

                                <form th:action="@{'/goals/delete/' + ${goal.id}}" method="post"
                                      onsubmit="return confirm('Are you sure you want to delete this goal?');">
                                    <button type="submit" class="delete-btn">Delete</button>
                                </form>
                            </div>

                        </div>
                    </div>

                </div>


                <!-- Attendance Tab -->
                <div id="sessions" class="tab-content"
                     th:classappend="${activeTab eq 'sessions'} ? ' active' : ''">
                    <div class="skills-header">
                        <h2 class="skills-title">Mentee Attendance</h2>
                    </div>

                    <!-- Filter Form -->
                    <form th:action="@{/attendance}" method="get" class="attendance-filter-form">
                        <input type="hidden" name="activeTab" value="sessions"/>

                        <label>Month:</label>
                        <input type="month" name="month" th:value="${filterMonth}" />

                        <label>Status:</label>
                        <select name="status">
                            <option value="">All</option>
                            <option th:value="PRESENT" th:selected="${selectedStatus == 'PRESENT'}">Attended</option>
                            <option th:value="ABSENT" th:selected="${selectedStatus == 'ABSENT'}">Absent</option>
                            <option th:value="NOT_YET" th:selected="${selectedStatus == 'NOT_YET'}">Not yet</option>
                        </select>

                        <label>Course:</label>
                        <select name="courseId">
                            <option value="">All</option>
                            <option th:each="course : ${courseList}"
                                    th:value="${course.id}"
                                    th:text="${course.name}"
                                    th:selected="${selectedCourseId != null and course.id.equals(selectedCourseId)}">
                            </option>
                        </select>

                        <button type="submit">Filter</button>
                    </form>


                    <!-- Attendance Records -->
                    <div class="attendance-records-container">
                        <!-- Show message if no records -->
                        <div th:if="${#lists.isEmpty(schedules)}" class="no-records-message">
                            <p>No attendance records found for the selected criteria.</p>
                        </div>

                        <!-- Attendance Records -->
                        <div class="attendance-card" th:each="schedule : ${schedules}">
                            <div class="attendance-left" th:text="${#temporals.format(schedule.date, 'MM/dd')}">06/12</div>
                            <div class="attendance-right">
                                <div class="session-title" th:text="${schedule.enrollment.courseMentor.course.name}">React</div>
                                <div class="session-meta">
                                    <span th:text="${schedule.enrollment.courseMentor.mentor.fullName}">John Mentor</span> •
                                    <span th:text="${#temporals.format(schedule.slot.startTime, 'HH:mm')} + ' - ' + ${#temporals.format(schedule.slot.endTime, 'HH:mm')}">07:30 - 09:00</span>
                                </div>
                                <div class="attendance-status" th:text="${schedule.attendance}">PRESENT</div>

                                <form method="post" th:action="@{/report}" class="report-form">
                                    <input type="hidden" name="scheduleId" th:value="${schedule.id}" />
                                    <input type="text" name="report"
                                           th:value="${schedule.report}"
                                           placeholder="Report an issue (e.g., mentor didn't teach)"
                                           required />
                                    <button type="submit">Report</button>
                                </form>

                                <div id="toast" class="toast" th:if="${success}" th:text="${success}"></div>
                                <div id="toast-error" class="toast error" th:if="${error}" th:text="${error}"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pagination" th:if="${totalPages > 0}">
                        <ul class="pagination-list">
                            <!-- Previous button -->
                            <li th:if="${currentPage > 0}">
                                <a th:href="@{/attendance(
                    page=${currentPage - 1},
                    month=${filterMonth},
                    courseId=${selectedCourseId},
                    status=${selectedStatus},
                    activeTab='sessions'
                )}" class="pagination-link">Prev</a>
                            </li>

                            <!-- Page numbers -->
                            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active' : ''">
                                <a th:href="@{/attendance(
                    page=${i},
                    month=${filterMonth},
                    courseId=${selectedCourseId},
                    status=${selectedStatus},
                    activeTab='sessions'
                )}" th:text="${i + 1}" class="pagination-link"></a>
                            </li>

                            <!-- Next button -->
                            <li th:if="${currentPage < totalPages - 1}">
                                <a th:href="@{/attendance(
                    page=${currentPage + 1},
                    month=${filterMonth},
                    courseId=${selectedCourseId},
                    status=${selectedStatus},
                    activeTab='sessions'
                )}" class="pagination-link">Next</a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </section>
</main>

<!--
- #FOOTER
-->
<th:block th:insert="~{fragments/footer :: footer}"></th:block>

<!--
- custom js link
-->
<script th:src="@{/assets/js/courlist.js}"></script>

<!-- Ionicons -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toast = document.getElementById("toast");
        const errorToast = document.getElementById("toast-error");
        if (toast) {
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }
        if (errorToast) {
            errorToast.classList.add("show");
            setTimeout(() => errorToast.classList.remove("show"), 3000);
        }
    });

    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // Remove active class from all buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab content
        const tabContent = document.getElementById(tabName);
        if (tabContent) {
            tabContent.classList.add('active');
        }

        // Add active class to clicked button
        const button = Array.from(document.querySelectorAll('.tab-btn'))
            .find(btn => btn.textContent.trim().toLowerCase() === tabName.toLowerCase());
        if (button) button.classList.add('active');
    }

    function toggleGoalForm() {
        const form = document.getElementById("goalFormContainer");
        form.classList.toggle("show");
    }

    (function () {
        const hash = window.location.hash;
        if (hash) {
            const tab = hash.substring(1);
            setTimeout(() => {
                switchTab(tab);
            }, 0);
        }
    })();

    function setGoalStatus(clickedButton, status) {
        const form = clickedButton.closest("form");
        const goalItem = clickedButton.closest(".goal-item");
        const allButtons = form.querySelectorAll(".progress-btn");
        allButtons.forEach(btn => btn.classList.remove('active'));
        clickedButton.classList.add('active');
        goalItem.className = 'goal-item ' + status.toLowerCase().replace('_', '-');
        form.querySelector(".status-input").value = status;
        form.submit();
    }

    function toggleEditForm(button) {
        const goalItem = button.closest(".goal-item");
        const form = goalItem.querySelector(".edit-goal-form");
        form.style.display = form.style.display === "none" ? "block" : "none";
    }
    document.addEventListener('DOMContentLoaded', function () {
        // Existing toast code
        const toast = document.getElementById("toast");
        const errorToast = document.getElementById("toast-error");
        if (toast) {
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }
        if (errorToast) {
            errorToast.classList.add("show");
            setTimeout(() => errorToast.classList.remove("show"), 3000);
        }

        // New code for attendance status colors
        setAttendanceColors();
    });

    function setAttendanceColors() {
        // Lấy tất cả attendance cards
        const attendanceCards = document.querySelectorAll('.attendance-card');

        attendanceCards.forEach(card => {
            // Tìm attendance status element
            const statusElement = card.querySelector('.attendance-status');
            // Tìm report input để check có report không
            const reportInput = card.querySelector('.report-form input[type="text"]');

            if (statusElement) {
                const status = statusElement.textContent.trim().toUpperCase();
                const hasReport = reportInput && reportInput.value && reportInput.value.trim() !== '';

                // Remove existing status classes
                card.classList.remove('present', 'absent', 'not-yet', 'cancelled', 'reported');
                statusElement.classList.remove('present', 'absent', 'not-yet', 'cancelled', 'reported');

                // Add appropriate classes based on status and report
                if (hasReport) {
                    // Nếu có report thì ưu tiên màu vàng
                    card.classList.add('reported');
                    statusElement.classList.add('reported');
                } else {
                    // Áp dụng màu theo status
                    switch(status) {
                        case 'PRESENT':
                            card.classList.add('present');
                            statusElement.classList.add('present');
                            break;
                        case 'ABSENT':
                            card.classList.add('absent');
                            statusElement.classList.add('absent');
                            break;
                        case 'NOT_YET':
                        case 'NOT YET':
                            card.classList.add('not-yet');
                            statusElement.classList.add('not-yet');
                            break;
                        case 'CANCELLED':
                            card.classList.add('cancelled');
                            statusElement.classList.add('cancelled');
                            break;
                        default:
                            // Default case for unknown status
                            card.classList.add('not-yet');
                            statusElement.classList.add('not-yet');
                    }
                }
            }
        });
    }

    // Function to update colors when report is submitted
    function updateAttendanceColors() {
        setTimeout(() => {
            setAttendanceColors();
        }, 100);
    }

    // Listen for form submissions to update colors
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('report-form')) {
            updateAttendanceColors();
        }
    });

    // Listen for input changes in report forms
    document.addEventListener('input', function(e) {
        if (e.target.matches('.report-form input[type="text"]')) {
            updateAttendanceColors();
        }
    });
</script>


</body>
</html>