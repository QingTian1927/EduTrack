<div th:fragment="chatbox">
    <div id="chat-container">
        <div id="chat-toggle" onclick="openChat()" style="display: flex;">
            ðŸ’¬
        </div>
        <div id="chatbox" style="display: none;">
            <div id="chat-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: bold;">Runeterra</span>
                <button onclick="closeChat()" style="background: none; border: none; font-size: 16px; cursor: pointer;">âœ–</button>
            </div>
            <div id="chatlog" style="max-height: 400px; overflow-y: auto; padding: 5px; background: #fafafa; border-radius: 8px; border: 1px solid #ddd;"></div>
            <div style="display: flex; margin-top: 10px;">
                <input type="text" id="userInput" placeholder="Ask something..." style="flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc;" onkeydown="checkEnter(event)">
                <button onclick="sendMessage()" style="margin-left: 5px; padding: 10px 16px;">Send</button>
            </div>
        </div>
    </div>

    <style>
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-toggle {
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            font-size: 28px;
            transition: background-color 0.3s ease;
        }

        #chat-toggle:hover {
            background-color: #0056b3;
        }

        #chatbox {
            width: 400px;
            background: #ffffff;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            margin: 10px 0;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }

        .bot-message {
            background-color: #e9ecef;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        #chatlog {
            display: flex;
            flex-direction: column;
        }

        .fade {
            animation: fade 0.5s ease-in-out;
            display: inline;
        }

        @keyframes fade {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .dot-typing {
            display: inline;
        }

        .dot-typing::after {
            content: '';
            animation: dots 1.2s steps(4, end) infinite;
        }

        @keyframes dots {
            0%   { content: ''; }
            25%  { content: '.'; }
            50%  { content: '..'; }
            75%  { content: '...'; }
            100% { content: ''; }
        }
    </style>

    <script>
        let chatHistory = [];
        const thinkingQuotes = [
            "Sharpening the strategy",
            "Schemes are being refined",
            "Strength is gathering",
            "Weighing every decision",
            "Standing firm, considering the next move",
            "Order takes time to uphold",
            "Calibrating intricate mechanisms",
            "Running complex calculations",
            "Aligning every cog perfectly",
            "Letting it simmer a bit longer",
            "Brewing something volatile",
            "Experiment still in progress",
            "Letting thoughts flow gently",
            "Seeking inner balance",
            "Patience guides the way",
            "Enduring the cold, answers will come",
            "Waiting out the storm",
            "Steeling resolve in the frost",
            "Shifting through ancient sands",
            "Unearthing forgotten knowledge",
            "Following trails buried in time",
            "Listening to the whispers beyond",
            "Peering through the mist",
            "Waiting for shadows to reveal themselves",
            "Watching the tides closely",
            "Waiting for the perfect wind",
            "Charting a course through murky waters",
            "Tracing the stars above",
            "Waiting for cosmic signs",
            "Contemplating the celestial path",
            "Wandering through curious thoughts",
            "Letting whimsy guide the way",
            "Cooking up something fun",
            "Listening to the pulse of nature",
            "Attuning with elemental forces",
            "Preparing a primal solution"
        ];

        function openChat() {
            document.getElementById('chatbox').style.display = 'block';
            document.getElementById('chat-toggle').style.display = 'none';
        }

        function closeChat() {
            document.getElementById('chatbox').style.display = 'none';
            document.getElementById('chat-toggle').style.display = 'flex';
        }

        function checkEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const inputField = document.getElementById("userInput");
            const message = inputField.value.trim();
            if (!message) return;

            const chatlog = document.getElementById("chatlog");

            // Add user message to UI
            const userMessage = document.createElement("div");
            userMessage.className = "chat-message user-message";
            userMessage.textContent = message;
            chatlog.appendChild(userMessage);
            chatlog.scrollTop = chatlog.scrollHeight;

            // Store user message to history
            chatHistory.push(message);

            // Clear input
            inputField.value = "";

            // Show "thinking..." message
            const thinkingMessage = document.createElement("div");
            thinkingMessage.className = "chat-message bot-message";
            chatlog.appendChild(thinkingMessage);
            chatlog.scrollTop = chatlog.scrollHeight;

            let currentQuote = getRandomQuote();
            thinkingMessage.innerHTML = `<span class="fade">${currentQuote}</span><span class="dot-typing"></span>`;

            const quoteInterval = setInterval(() => {
                currentQuote = getRandomQuote();
                const quoteSpan = document.createElement("span");
                quoteSpan.className = "fade";
                quoteSpan.textContent = currentQuote;
                thinkingMessage.innerHTML = '';
                thinkingMessage.appendChild(quoteSpan);
                const dotSpan = document.createElement("span");
                dotSpan.className = "dot-typing";
                thinkingMessage.appendChild(dotSpan);
                chatlog.scrollTop = chatlog.scrollHeight;
            }, 10000);

            try {
                const res = await fetch("http://localhost:8000/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message,
                        history: chatHistory
                    })
                });

                const data = await res.json();
                clearInterval(quoteInterval);

                thinkingMessage.innerHTML = data.reply
                    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                    .replace(/\n/g, "<br>");

                // Save bot reply to history
                chatHistory.push(data.reply);
            } catch (err) {
                clearInterval(quoteInterval);
                thinkingMessage.textContent = "Error: Unable to get reply.";
            }

            chatlog.scrollTop = chatlog.scrollHeight;
        }


        function getRandomQuote() {
            const index = Math.floor(Math.random() * thinkingQuotes.length);
            return thinkingQuotes[index];
        }
    </script>
</div>
